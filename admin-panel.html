<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Race Admin Panel</title>
</head>
<body>
  <h1>PHRF Race Admin Panel</h1>

  <label for="distance">Race Distance (nautical miles): </label>
  <input type="number" id="distance" step="0.01" required>
  
  <br><br>

  <table id="raceTable" border="1">
    <thead>
      <tr>
        <th>Boat Name</th>
        <th>PHRF</th>
        <th>Elapsed Time (min)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" placeholder="Boat 1"></td>
        <td><input type="number" placeholder="e.g. 150"></td>
        <td><input type="number" placeholder="e.g. 90"></td>
      </tr>
    </tbody>
  </table>
  <button onclick="addRow()">Add Row</button>
  <br><br>
  <button onclick="computeAndSave()">Compute & Save</button>
  <button onclick="publishResults()">Publish to Live Site</button>

  <pre id="status"></pre>

  <script>
    function addRow() {
      const table = document.getElementById("raceTable").getElementsByTagName('tbody')[0];
      const newRow = table.insertRow();
      for (let i = 0; i < 3; i++) {
        const cell = newRow.insertCell();
        const input = document.createElement("input");
        input.type = i === 0 ? "text" : "number";
        cell.appendChild(input);
      }
    }

    function computeAndSave() {
      const rows = document.querySelectorAll("#raceTable tbody tr");
      const distance = parseFloat(document.getElementById("distance").value);
      if (isNaN(distance) || distance <= 0) {
        alert("Please enter a valid race distance.");
        return;
      }

      const results = [];
      for (const row of rows) {
        const [nameInput, phrfInput, timeInput] = row.querySelectorAll("input");
        const name = nameInput.value;
        const phrf = parseFloat(phrfInput.value);
        const elapsed = parseFloat(timeInput.value);

        if (!name || isNaN(phrf) || isNaN(elapsed)) continue;

        const correctedTime = elapsed - (phrf * distance) / 60;
        results.push({ name, phrf, elapsed, correctedTime });
      }

      localStorage.setItem("raceResults", JSON.stringify(results));
      document.getElementById("status").textContent = "Results saved locally.";
    }

    async function publishResults() {
      const data = localStorage.getItem("raceResults");
      if (!data) {
        alert("No results to publish.");
        return;
      }

      const res = await fetch("/.netlify/functions/publish", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: data
      });

      const result = await res.text();
      document.getElementById("status").textContent = "Publish response: " + result;
    }
  </script>
</body>
</html>